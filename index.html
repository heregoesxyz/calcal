<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monthly Journal</title>
  <style>
    :root{
      --bg:#0b0d10;
      --muted:#8a93a0;
      --text:#e8edf4;
      --line:rgba(255,255,255,.08);

      --cardA:rgba(255,255,255,.04);
      --cardB:rgba(255,255,255,.02);

      /* Month palette */
      --tab1:#1d4ed8; --tab2:#0ea5e9; --tab3:#22c55e; --tab4:#94a3b8;
      --tab5:#f59e0b; --tab6:#fb7185; --tab7:#a78bfa; --tab8:#60a5fa;
      --tab9:#34d399; --tab10:#f97316; --tab11:#f43f5e; --tab12:#eab308;

      /* Active month accent (set by JS) */
      --accent: var(--tab1);

      --barPrimary:#2a3340;
      --barHoliday:#203242;
      --barBorder:rgba(255,255,255,.10);
      --barText:rgba(232,237,244,.95);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(90,120,255,.10), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(255,180,90,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* ===== TOP ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding:22px 22px 10px;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{font-size:22px; letter-spacing:.06em; text-transform:uppercase}
    .subtitle{color:var(--muted); font-size:12px; margin-top:4px}

    .nav{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .nav button{
      width:40px; height:40px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;
      font-size:20px;
      cursor:pointer;
    }
    .nav button:hover{background:rgba(255,255,255,.07)}
    .monthLabel{
      min-width:200px;
      text-align:center;
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:rgba(232,237,244,.92);
    }

    .actionBtns{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pillBtn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:rgba(232,237,244,.92);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:hover{background:rgba(255,255,255,.07)}
    .pillDot{
      width:10px; height:10px; border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(255,255,255,.06);
    }

    /* ===== UPCOMING ===== */
    .upcomingSticky{
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(11,13,16,.65);
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 22px 12px;
    }
    .upcomingRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .upcomingHeader{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      margin-bottom:8px;
    }
    .toggles{
      display:flex;
      gap:10px;
      align-items:center;
      color:rgba(232,237,244,.85);
      font-size:12px;
      user-select:none;
    }
    .toggles label{
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
    }
    .upcomingList{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
      scroll-snap-type:x mandatory;
      scrollbar-width:thin;
    }
    .upcomingList::-webkit-scrollbar{height:8px}
    .upcomingList::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.12);
      border-radius:999px;
    }
    .upcomingItem{
      scroll-snap-align:start;
      min-width:240px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:10px 12px;
      outline:1px solid color-mix(in oklab, var(--accent) 35%, transparent);
    }
    .upcomingWhen{color:var(--muted); font-size:12px}
    .upcomingTitle{margin-top:6px; font-weight:600; font-size:14px; line-height:1.2}
    .badge{
      display:inline-block;
      margin-top:8px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:rgba(232,237,244,.85);
    }
    .scrollHint{
      margin-top:8px;
      color:rgba(138,147,160,.9);
      font-size:12px;
    }

    .status{
      color:var(--muted);
      font-size:12px;
      padding:0 22px 12px;
      white-space:pre-wrap;
    }

    /* ====== LAYOUT ====== */
    .container{padding:18px 22px 30px}
    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }

    /* ====== CARDS (color-coded outline) ====== */
    .calendarCard,
    .panel{
      border-radius:22px;
      overflow:hidden;
      background:linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid rgba(255,255,255,.08);
      outline:1px solid color-mix(in oklab, var(--accent) 50%, transparent);
      box-shadow:0 20px 50px rgba(0,0,0,.25);
    }

    .calendarCard{
      position:relative;
      padding-right:50px; /* month tabs */
    }

    .dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      padding:14px 14px 10px;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    .gridWrap{ position:relative; }
    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
    }
    .day{
      min-height:128px;
      border-right:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:12px;
      position:relative;
      cursor:pointer;
    }
    .day:hover{ background:rgba(255,255,255,.02); }
    .day:nth-child(7n){border-right:none}
    .day.selected{
      outline:2px solid rgba(255,255,255,.18);
      outline-offset:-2px;
      background:rgba(255,255,255,.03);
    }
    .dayNum{
      color:rgba(232,237,244,.92);
      font-size:12px;
      font-weight:800;
      letter-spacing:.06em;
    }
    .dayNum.muted{color:rgba(138,147,160,.70)}
    .todayDot{
      position:absolute;
      top:12px; right:12px;
      width:8px; height:8px; border-radius:50%;
      background:rgba(255,255,255,.65);
      box-shadow:0 0 0 3px rgba(255,255,255,.08);
    }
    /* Journal indicator dot */
    .journalDot{
      position:absolute;
      top:12px; right:28px;
      width:8px; height:8px; border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 3px rgba(255,255,255,.06);
      opacity:.95;
    }

    /* multiday layer */
    .barsLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .bar{
      position:absolute;
      height:18px;
      border:1px solid var(--barBorder);
      border-radius:10px;
      padding:0 8px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--barText);
      background:var(--barPrimary);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
      pointer-events:auto;
      cursor:pointer;
    }
    .bar.holiday{ background: var(--barHoliday); }
    .bar .tiny{
      font-size:10px;
      color:rgba(232,237,244,.75);
      margin-left:auto;
    }

    .chips{margin-top:26px; display:flex; flex-direction:column; gap:6px}
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:10px;
      padding:6px 8px;
      font-size:12px;
      color:rgba(232,237,244,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip.holiday{background:rgba(255,255,255,.06)}
    .more{color:var(--muted); font-size:12px; margin-top:2px}

    /* ====== RIGHT RAIL ====== */
    .rail{
      position:sticky;
      top:86px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    @media (max-width: 980px){
      .rail{position:relative; top:auto;}
    }
    .panelHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .panelMeta{
      font-size:12px;
      color:rgba(232,237,244,.85);
      font-weight:700;
    }
    .panelBody{padding:14px}

    /* Month tabs */
    .monthTabs{
      position:absolute;
      top:56px;
      right:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      z-index:5;
    }
    .tab{
      width:34px;
      height:42px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .tab:hover{background:rgba(255,255,255,.08)}
    .tab.active{
      outline:2px solid rgba(255,255,255,.18);
      outline-offset:-2px;
    }
    .tab span{
      font-size:10px;
      letter-spacing:.16em;
      text-transform:uppercase;
      transform:rotate(90deg);
      color:rgba(232,237,244,.92);
      font-weight:900;
      position:relative;
      z-index:1;
    }
    .tab::before{
      content:"";
      position:absolute; inset:0;
      opacity:.70;
    }
    .tab[data-m="0"]::before{ background:var(--tab1); }
    .tab[data-m="1"]::before{ background:var(--tab2); }
    .tab[data-m="2"]::before{ background:var(--tab3); }
    .tab[data-m="3"]::before{ background:var(--tab4); }
    .tab[data-m="4"]::before{ background:var(--tab5); }
    .tab[data-m="5"]::before{ background:var(--tab6); }
    .tab[data-m="6"]::before{ background:var(--tab7); }
    .tab[data-m="7"]::before{ background:var(--tab8); }
    .tab[data-m="8"]::before{ background:var(--tab9); }
    .tab[data-m="9"]::before{ background:var(--tab10); }
    .tab[data-m="10"]::before{ background:var(--tab11); }
    .tab[data-m="11"]::before{ background:var(--tab12); }

    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:rgba(232,237,244,.95);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-size:13px;
      line-height:1.45;
    }
    textarea:focus{
      border-color:color-mix(in oklab, var(--accent) 55%, rgba(255,255,255,.12));
      box-shadow:0 0 0 4px rgba(255,255,255,.06);
    }
    .btnRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:rgba(232,237,244,.95);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:900;
      flex:1;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    code{color:rgba(232,237,244,.85)}

    /* ===== PRINT (Save as PDF) ===== */
    #printSheet{
      display:none;
      color:#000;
      background:#fff;
      padding:0;
    }
    #printSheet .pwrap{
      padding:0.35in;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    #printSheet h1{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    #printSheet .pmeta{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:11px;
      margin-bottom:10px;
    }
    #printSheet .pgrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      border:1px solid #333;
      font-size:10px;
    }
    #printSheet .pdow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom:4px;
      font-weight:700;
      font-size:10px;
    }
    #printSheet .pcell{
      min-height:0.9in;
      border-right:1px solid #333;
      border-bottom:1px solid #333;
      padding:6px;
      position:relative;
      overflow:hidden;
    }
    #printSheet .pcell:nth-child(7n){border-right:none}
    #printSheet .pnum{font-weight:800; font-size:10px}
    #printSheet .pevt{margin-top:4px; font-size:9px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    #printSheet .psectionRow{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:12px;
      margin-top:10px;
      align-items:start;
    }
    #printSheet .pbox{
      border:1px solid #333;
      padding:8px;
      border-radius:8px;
    }
    #printSheet .pbox h2{
      margin:0 0 8px 0;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    #printSheet .pupItem{
      font-size:10px;
      margin-bottom:6px;
    }
    #printSheet .pupWhen{
      font-weight:700;
    }
    #printSheet .pjItem{
      font-size:10px;
      margin-bottom:8px;
    }
    #printSheet .pjDate{
      font-weight:800;
    }
    #printSheet .pjText{
      margin-top:3px;
      white-space:pre-wrap;
      max-height:0.5in;
      overflow:hidden;
    }

    @media print{
      @page { size: letter landscape; margin: 0; }
      body > *:not(#printSheet){ display:none !important; }
      #printSheet{ display:block !important; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">Monthly Journal</div>
      <div class="subtitle">month tabs · multiday bars · journal dots · print-to-PDF</div>
    </div>

    <div class="nav">
      <button id="prevBtn" aria-label="Previous month">‹</button>
      <div id="monthLabel" class="monthLabel"></div>
      <button id="nextBtn" aria-label="Next month">›</button>

      <div class="actionBtns">
        <a id="runActionBtn" class="pillBtn" href="#" target="_blank" rel="noopener">
          <span class="pillDot"></span>
          Run GitHub Action
        </a>
        <button id="printBtn" class="pillBtn" type="button">
          <span class="pillDot"></span>
          Print / Save PDF
        </button>
      </div>
    </div>
  </header>

  <section class="upcomingSticky">
    <div class="upcomingRow">
      <div class="upcomingHeader">Upcoming</div>
      <div class="toggles" title="Toggle holiday visibility">
        <!-- Default: NO holidays in upcoming -->
        <label><input id="holUpcoming" type="checkbox" /> Holidays in upcoming</label>
        <label><input id="holMonth" type="checkbox" checked /> Holidays in month</label>
      </div>
    </div>
    <div id="upcomingList" class="upcomingList"></div>
    <div class="scrollHint">Scroll → to view more upcoming events</div>
  </section>

  <div id="status" class="status"></div>

  <main class="container">
    <div class="layout">
      <section class="calendarCard">
        <div class="dow">
          <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
        </div>

        <div id="monthTabs" class="monthTabs" aria-label="Month tabs"></div>

        <div class="gridWrap" id="gridWrap">
          <div id="barsLayer" class="barsLayer"></div>
          <div id="grid" class="grid"></div>
        </div>
      </section>

      <aside class="rail">
        <section class="panel">
          <div class="panelHead">
            <div class="panelTitle">Selected day</div>
            <div id="selectedMeta" class="panelMeta">—</div>
          </div>
          <div class="panelBody">
            <div id="selectedDateLabel" style="font-weight:900;letter-spacing:.06em;text-transform:uppercase;">Click a day</div>
            <div style="height:10px"></div>
            <textarea id="journalText" placeholder="Write a journal entry… (saved locally)"></textarea>
            <div class="btnRow">
              <button id="saveBtn" class="btn" type="button">Save</button>
              <button id="clearBtn" class="btn" type="button">Clear</button>
            </div>
            <div class="hint">
              Journal entries are stored in <code>localStorage</code> on this device/browser only.
              Days with notes get a colored dot in the calendar.
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panelHead">
            <div class="panelTitle">Setup</div>
            <div class="panelMeta">No CORS</div>
          </div>
          <div class="panelBody">
            <div class="hint">
              This page loads local mirrored feeds: <code>./data/primary.ics</code> and <code>./data/holidays.ics</code>.
              A GitHub Action refreshes those. The “Run GitHub Action” button opens the workflow page (you must be logged in).
            </div>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <!-- PRINT SHEET (rendered on-demand, printed as letter landscape; user chooses Save as PDF) -->
  <section id="printSheet" aria-hidden="true">
    <div class="pwrap">
      <h1 id="pTitle">Monthly Journal</h1>
      <div class="pmeta">
        <div id="pMonth"></div>
        <div id="pGenerated"></div>
      </div>

      <div class="pdow">
        <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
      </div>
      <div id="pGrid" class="pgrid"></div>

      <div class="psectionRow">
        <div class="pbox">
          <h2>Upcoming</h2>
          <div id="pUpcoming"></div>
        </div>
        <div class="pbox">
          <h2>Journal entries</h2>
          <div id="pJournal"></div>
        </div>
      </div>
    </div>
  </section>

<script>
/** ====== IMPORTANT ======
 * Loads local mirrored feeds generated by the GitHub Action:
 *   /data/primary.ics
 *   /data/holidays.ics
 */
const PRIMARY_ICS_URL = "./data/primary.ics";
const HOLIDAYS_ICS_URL = "./data/holidays.ics";

/** Upcoming behavior */
const UPCOMING_PIN_COUNT = 5;          // "Top" pinned list (first 5)
const UPCOMING_SCROLL_COUNT = 30;      // Render more so you can scroll further out

/** Month grid chips */
const MAX_DAY_CHIPS = 3;

/** Journal print */
const PRINT_JOURNAL_MAX = 6;

/** ===== DOM ===== */
const elGrid = document.getElementById("grid");
const elBars = document.getElementById("barsLayer");
const elUpcoming = document.getElementById("upcomingList");
const elMonthLabel = document.getElementById("monthLabel");
const elStatus = document.getElementById("status");
const monthTabsEl = document.getElementById("monthTabs");

const holUpcomingToggle = document.getElementById("holUpcoming");
const holMonthToggle = document.getElementById("holMonth");

const selectedMeta = document.getElementById("selectedMeta");
const selectedDateLabel = document.getElementById("selectedDateLabel");
const journalText = document.getElementById("journalText");
const saveBtn = document.getElementById("saveBtn");
const clearBtn = document.getElementById("clearBtn");

const printBtn = document.getElementById("printBtn");
const runActionBtn = document.getElementById("runActionBtn");

const pMonth = document.getElementById("pMonth");
const pGenerated = document.getElementById("pGenerated");
const pGrid = document.getElementById("pGrid");
const pUpcoming = document.getElementById("pUpcoming");
const pJournal = document.getElementById("pJournal");

/** ===== State ===== */
let viewMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
let primaryEvents = [];
let holidayEvents = [];
let selectedYMD = null;

/** ===== GitHub Action “Run” button =====
 * NOTE: A static GitHub Pages site cannot programmatically trigger a workflow_dispatch without authentication.
 * This button opens the workflow page where you can click “Run workflow”.
 *
 * Replace placeholders:
 *  - <OWNER>, <REPO>, <WORKFLOW_FILE>
 */
const GITHUB_OWNER = "<OWNER>";
const GITHUB_REPO = "<REPO>";
const WORKFLOW_FILE = "fetch-ical.yml"; // must match the filename in .github/workflows/
const actionsUrl = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/${WORKFLOW_FILE}`;
runActionBtn.href = actionsUrl;

/** ===== Events ===== */
document.getElementById("prevBtn").addEventListener("click", () => shiftMonth(-1));
document.getElementById("nextBtn").addEventListener("click", () => shiftMonth(1));
holUpcomingToggle.addEventListener("change", render);
holMonthToggle.addEventListener("change", render);

saveBtn.addEventListener("click", () => {
  if (!selectedYMD) return;
  localStorage.setItem(journalKey(selectedYMD), journalText.value);
  bumpSelectedMeta("Saved");
  // update journal dots on calendar
  updateJournalDots();
});

clearBtn.addEventListener("click", () => {
  if (!selectedYMD) return;
  localStorage.removeItem(journalKey(selectedYMD));
  journalText.value = "";
  bumpSelectedMeta("Cleared");
  updateJournalDots();
});

printBtn.addEventListener("click", async () => {
  buildPrintSheet();
  // Let layout settle for a tick
  await new Promise(r => setTimeout(r, 50));
  window.print(); // user chooses "Save as PDF"
});

/** ===== Helpers ===== */
function ymd(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function parseYMD(s){
  const [Y,M,D] = s.split("-").map(Number);
  return new Date(Y, M-1, D);
}
function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}
function clampToDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function startOfGrid(monthDate){
  const s = startOfMonth(monthDate);
  s.setDate(s.getDate() - s.getDay());
  return s;
}
function endOfGrid(monthDate){
  const e = new Date(monthDate.getFullYear(), monthDate.getMonth()+1, 1);
  e.setDate(e.getDate() + (7 - e.getDay()));
  return e;
}
function fmtMonthLabel(d){
  return d.toLocaleString(undefined, { month:"long", year:"numeric" }).toUpperCase();
}
function startMs(ev){ return new Date(ev.start).getTime(); }
function fmtUpcomingWhen(ev){
  const d = new Date(ev.start);
  return ev.allDay
    ? d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" })
    : d.toLocaleString(undefined, { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function debounce(fn, ms){
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
}

/** ===== Accent (month color) ===== */
function setAccentForMonth(monthIdx){
  const map = [
    "var(--tab1)","var(--tab2)","var(--tab3)","var(--tab4)",
    "var(--tab5)","var(--tab6)","var(--tab7)","var(--tab8)",
    "var(--tab9)","var(--tab10)","var(--tab11)","var(--tab12)",
  ];
  document.documentElement.style.setProperty("--accent", map[monthIdx] || "var(--tab1)");
}

/** ===== ICS parsing ===== */
function normalizeICSDate(value){
  const v = value.trim();
  if (/^\d{8}$/.test(v)) {
    const yyyy=v.slice(0,4), mm=v.slice(4,6), dd=v.slice(6,8);
    return { iso: `${yyyy}-${mm}-${dd}T00:00:00`, allDay:true };
  }
  let iso = v;
  iso = iso.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z$/, "$1-$2-$3T$4:$5:$6Z");
  iso = iso.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})$/, "$1-$2-$3T$4:$5:$6");
  iso = iso.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})Z$/, "$1-$2-$3T$4:$5:00Z");
  iso = iso.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})$/, "$1-$2-$3T$4:$5:00");
  return { iso, allDay:false };
}
function unfoldICS(text){
  return text.replace(/\r?\n[ \t]/g, "");
}
function parseICS(text, source){
  const unfolded = unfoldICS(text);
  const blocks = unfolded.split("BEGIN:VEVENT").slice(1);
  const events = [];

  for (const block of blocks){
    const vevent = block.split("END:VEVENT")[0];
    const lines = vevent.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

    let summary = "";
    let dtstart = null;
    let dtend = null;

    for (const line of lines){
      if (line.startsWith("SUMMARY:")) summary = line.slice(8).trim();
      else if (line.startsWith("DTSTART")){
        const raw = line.split(":").slice(1).join(":");
        dtstart = normalizeICSDate(raw);
      } else if (line.startsWith("DTEND")){
        const raw = line.split(":").slice(1).join(":");
        dtend = normalizeICSDate(raw);
      }
    }
    if (!summary || !dtstart) continue;

    const startIso = dtstart.iso;
    const endIso = (dtend ? dtend.iso : dtstart.iso);

    events.push({
      id: (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random())),
      title: summary,
      start: startIso,
      end: endIso,
      allDay: dtstart.allDay,
      source, // primary|holiday
    });
  }
  return events;
}

/** ===== Month tabs ===== */
const MONTH_ABBR = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
function buildMonthTabs(){
  monthTabsEl.innerHTML = "";
  for (let m=0; m<12; m++){
    const tab = document.createElement("div");
    tab.className = "tab";
    tab.dataset.m = String(m);
    tab.title = MONTH_ABBR[m];
    tab.innerHTML = `<span>${MONTH_ABBR[m]}</span>`;
    tab.addEventListener("click", () => {
      viewMonth = new Date(viewMonth.getFullYear(), m, 1);
      render();
    });
    monthTabsEl.appendChild(tab);
  }
}
function setActiveMonthTab(){
  const m = viewMonth.getMonth();
  [...monthTabsEl.querySelectorAll(".tab")].forEach(t => t.classList.toggle("active", Number(t.dataset.m)===m));
}

/** ===== Upcoming (scrollable, no holidays by default) ===== */
function renderUpcoming(){
  const includeHol = holUpcomingToggle.checked;
  const now = new Date();

  const merged = [
    ...primaryEvents,
    ...(includeHol ? holidayEvents : []),
  ]
    .filter(ev => startMs(ev) >= now.getTime())
    .sort((a,b)=> startMs(a)-startMs(b))
    .slice(0, UPCOMING_SCROLL_COUNT);

  elUpcoming.innerHTML = "";
  if (merged.length === 0){
    elUpcoming.innerHTML = `<div class="upcomingItem"><div class="upcomingWhen">No upcoming events</div><div class="upcomingTitle">Add events to your calendar</div></div>`;
    return;
  }

  for (let i=0; i<merged.length; i++){
    const ev = merged[i];
    const badge =
      ev.source === "holiday" ? "Holiday" :
      ev.allDay ? "All-day" : "Event";

    const item = document.createElement("div");
    item.className = "upcomingItem";
    item.innerHTML = `
      <div class="upcomingWhen">${fmtUpcomingWhen(ev)}${i < UPCOMING_PIN_COUNT ? " · TOP" : ""}</div>
      <div class="upcomingTitle">${escapeHtml(ev.title)}</div>
      <div class="badge">${badge}</div>
    `;
    elUpcoming.appendChild(item);
  }
}

/** ===== Month grid + multiday bars ===== */
function shiftMonth(delta){
  viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth() + delta, 1);
  render();
}
function mergeForMonth(){
  const includeHol = holMonthToggle.checked;
  return [
    ...primaryEvents,
    ...(includeHol ? holidayEvents : []),
  ].sort((a,b)=> startMs(a)-startMs(b));
}
function isMultiDaySpan(ev){
  const s = clampToDay(new Date(ev.start));
  const e = clampToDay(new Date(ev.end));
  return e.getTime() > s.getTime();
}
function buildDayEventMap(singleDayEvents){
  const map = new Map();
  for (const ev of singleDayEvents){
    const s = clampToDay(new Date(ev.start));
    const key = ymd(s);
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(ev);
  }
  for (const [k, list] of map.entries()){
    list.sort((a,b)=> startMs(a)-startMs(b));
  }
  return map;
}

function renderMonthGrid(){
  setActiveMonthTab();
  setAccentForMonth(viewMonth.getMonth());

  elMonthLabel.textContent = fmtMonthLabel(viewMonth);
  elGrid.innerHTML = "";
  elBars.innerHTML = "";

  const merged = mergeForMonth();
  const gridStart = startOfGrid(viewMonth);
  const gridEnd = endOfGrid(viewMonth);

  const multiday = [];
  const singleDay = [];
  for (const ev of merged){
    if (isMultiDaySpan(ev)) multiday.push(ev);
    else singleDay.push(ev);
  }

  const days = [];
  const dayIndex = new Map();
  const d = new Date(gridStart);
  while (d < gridEnd){
    const key = ymd(d);
    dayIndex.set(key, days.length);
    days.push(new Date(d));
    d.setDate(d.getDate()+1);
  }

  const today = new Date();
  const monthNum = viewMonth.getMonth();

  for (let i=0; i<days.length; i++){
    const date = days[i];
    const key = ymd(date);

    const cell = document.createElement("div");
    cell.className = "day";
    cell.dataset.ymd = key;

    const muted = date.getMonth() !== monthNum;
    const num = document.createElement("div");
    num.className = "dayNum" + (muted ? " muted" : "");
    num.textContent = String(date.getDate());
    cell.appendChild(num);

    if (date.getFullYear()===today.getFullYear() && date.getMonth()===today.getMonth() && date.getDate()===today.getDate()){
      const dot = document.createElement("div");
      dot.className = "todayDot";
      cell.appendChild(dot);
    }

    // journal dot if entry exists
    if (hasJournalEntry(key)){
      const jdot = document.createElement("div");
      jdot.className = "journalDot";
      cell.appendChild(jdot);
    }

    cell.addEventListener("click", () => selectDay(key));

    const chipsWrap = document.createElement("div");
    chipsWrap.className = "chips";
    chipsWrap.dataset.chipsFor = key;
    cell.appendChild(chipsWrap);

    elGrid.appendChild(cell);
  }

  // chips
  const map = buildDayEventMap(singleDay);
  for (const [key, list] of map.entries()){
    const chipsWrap = elGrid.querySelector(`.chips[data-chips-for="${key}"]`);
    if (!chipsWrap) continue;
    const show = list.slice(0, MAX_DAY_CHIPS);
    for (const ev of show){
      const chip = document.createElement("div");
      chip.className = "chip" + (ev.source==="holiday" ? " holiday" : "");
      chip.title = ev.title;
      chip.textContent = ev.title;
      chipsWrap.appendChild(chip);
    }
    if (list.length > MAX_DAY_CHIPS){
      const more = document.createElement("div");
      more.className = "more";
      more.textContent = `+${list.length - MAX_DAY_CHIPS} more`;
      chipsWrap.appendChild(more);
    }
  }

  // bars
  layoutMultiDayBars(multiday, gridStart, gridEnd, dayIndex);

  // keep selection
  if (!selectedYMD) selectDay(ymd(new Date()));
  else selectDay(selectedYMD, {silent:true});
}

function layoutMultiDayBars(events, gridStart, gridEnd, dayIndex){
  const cellEls = [...elGrid.querySelectorAll(".day")];
  if (cellEls.length === 0) return;

  const gridRect = elGrid.getBoundingClientRect();
  function cellRect(idx){ return cellEls[idx].getBoundingClientRect(); }

  const rows = Math.ceil(cellEls.length/7);
  const lanes = Array.from({length: rows}, () => []);

  const normalized = events
    .map(ev => {
      let s = clampToDay(new Date(ev.start));
      let e = clampToDay(new Date(ev.end));
      if (e <= s) e = addDays(s, 1);

      const gs = clampToDay(gridStart);
      const ge = clampToDay(gridEnd);
      if (e <= gs || s >= ge) return null;
      if (s < gs) s = gs;
      if (e > ge) e = ge;
      return { ...ev, _s: s, _e: e };
    })
    .filter(Boolean)
    .sort((a,b)=> a._s - b._s);

  for (const ev of normalized){
    const startKey = ymd(ev._s);
    const endKeyEx = ymd(ev._e);
    const startIdx = dayIndex.get(startKey);
    const endIdxEx = dayIndex.get(endKeyEx);
    if (startIdx == null) continue;

    let endEx = (endIdxEx == null ? startIdx+1 : endIdxEx);
    let cursor = startIdx;

    while (cursor < endEx){
      const row = Math.floor(cursor/7);
      const rowStart = row*7;
      const rowEndEx = rowStart + 7;

      const segStart = cursor;
      const segEndEx = Math.min(endEx, rowEndEx);

      const startCol = segStart - rowStart;
      const endCol = (segEndEx - rowStart) - 1;

      const laneIndex = pickLane(lanes[row], startCol, endCol);
      lanes[row][laneIndex].push([startCol, endCol]);

      const leftCell = cellRect(segStart);
      const rightCell = cellRect(segEndEx - 1);

      const topWithinRow = 34 + laneIndex * 22;
      const top = (leftCell.top - gridRect.top) + topWithinRow;
      const left = (leftCell.left - gridRect.left) + 10;
      const right = (rightCell.right - gridRect.left) - 10;
      const width = Math.max(60, right - left);

      const bar = document.createElement("div");
      bar.className = "bar" + (ev.source==="holiday" ? " holiday" : "");
      bar.style.top = `${top}px`;
      bar.style.left = `${left}px`;
      bar.style.width = `${width}px`;

      const startsHere = segStart === startIdx;
      const endsHere = segEndEx === endEx;
      const cap = (startsHere ? "◀︎" : "…") + " " + escapeHtml(ev.title) + " " + (endsHere ? "▶︎" : "…");

      bar.innerHTML = `<div style="overflow:hidden;text-overflow:ellipsis">${cap}</div>
                       <div class="tiny">${ev.source==="holiday" ? "Holiday" : (ev.allDay ? "All-day" : "")}</div>`;

      bar.addEventListener("click", (e) => {
        e.stopPropagation();
        selectDay(ymd(ev._s));
      });

      elBars.appendChild(bar);
      cursor = segEndEx;
    }
  }

  function pickLane(rowLanes, s, e){
    for (let i=0; i<rowLanes.length; i++){
      if (!overlapsAny(rowLanes[i], s, e)) return i;
    }
    rowLanes.push([]);
    return rowLanes.length - 1;
  }
  function overlapsAny(segments, s, e){
    for (const [a,b] of segments){
      if (!(e < a || s > b)) return true;
    }
    return false;
  }
}

/** ===== Journal (localStorage) + dots ===== */
function journalKey(dayYMD){ return `journal:v1:${dayYMD}`; }
function hasJournalEntry(dayYMD){
  const v = localStorage.getItem(journalKey(dayYMD));
  return v != null && String(v).trim().length > 0;
}
function updateJournalDots(){
  // update dots for all visible cells
  for (const cell of elGrid.querySelectorAll(".day")){
    const key = cell.dataset.ymd;
    const existing = cell.querySelector(".journalDot");
    const needed = hasJournalEntry(key);
    if (needed && !existing){
      const jdot = document.createElement("div");
      jdot.className = "journalDot";
      cell.appendChild(jdot);
    } else if (!needed && existing){
      existing.remove();
    }
  }
}
function bumpSelectedMeta(text){
  selectedMeta.textContent = text;
  setTimeout(() => {
    selectedMeta.textContent = selectedYMD ? dayMeta(selectedYMD) : "—";
  }, 900);
}
function selectDay(dayYMD, opts={}){
  selectedYMD = dayYMD;

  [...elGrid.querySelectorAll(".day")].forEach(d => d.classList.toggle("selected", d.dataset.ymd === dayYMD));

  const d = parseYMD(dayYMD);
  const pretty = d.toLocaleDateString(undefined, { weekday:"long", month:"long", day:"numeric", year:"numeric" });
  selectedDateLabel.textContent = pretty.toUpperCase();

  journalText.value = localStorage.getItem(journalKey(dayYMD)) || "";
  selectedMeta.textContent = dayMeta(dayYMD);

  if (!opts.silent && window.innerWidth < 980){
    selectedDateLabel.scrollIntoView({behavior:"smooth", block:"nearest"});
  }
}
function dayMeta(dayYMD){
  const includeHol = holMonthToggle.checked;
  const merged = [
    ...primaryEvents,
    ...(includeHol ? holidayEvents : []),
  ];
  const dayStart = parseYMD(dayYMD);
  const dayEnd = addDays(dayStart, 1);

  let count = 0;
  for (const ev of merged){
    const s = new Date(ev.start);
    const e = new Date(ev.end);
    if (s < dayEnd && e > dayStart) count++;
  }
  return count === 1 ? "1 event" : `${count} events`;
}

/** ===== Print-to-PDF (letter landscape) ===== */
function buildPrintSheet(){
  // Header
  pMonth.textContent = fmtMonthLabel(viewMonth);
  pGenerated.textContent = `Generated: ${new Date().toLocaleString()}`;

  // Build month grid (simple + readable)
  pGrid.innerHTML = "";

  const includeHolMonth = holMonthToggle.checked;
  const merged = [
    ...primaryEvents,
    ...(includeHolMonth ? holidayEvents : []),
  ].sort((a,b)=> startMs(a)-startMs(b));

  const gridStart = startOfGrid(viewMonth);
  const gridEnd = endOfGrid(viewMonth);

  // Map: date -> list (starts on that day)
  const map = new Map();
  for (const ev of merged){
    const s = clampToDay(new Date(ev.start));
    // only show events that overlap visible grid range at all (simple filter)
    const e = new Date(ev.end);
    if (e <= gridStart || s >= gridEnd) continue;

    const key = ymd(s);
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(ev);
  }
  for (const [k, list] of map.entries()){
    list.sort((a,b)=> startMs(a)-startMs(b));
  }

  // Cells
  const monthNum = viewMonth.getMonth();
  let d = new Date(gridStart);
  while (d < gridEnd){
    const key = ymd(d);
    const muted = d.getMonth() !== monthNum;

    const cell = document.createElement("div");
    cell.className = "pcell";
    cell.innerHTML = `<div class="pnum" style="opacity:${muted ? 0.45 : 1}">${d.getDate()}</div>`;

    const list = map.get(key) || [];
    const show = list.slice(0, 3);
    for (const ev of show){
      const label = ev.source === "holiday" ? `★ ${ev.title}` : ev.title;
      const div = document.createElement("div");
      div.className = "pevt";
      div.textContent = label;
      cell.appendChild(div);
    }

    pGrid.appendChild(cell);
    d.setDate(d.getDate()+1);
  }

  // Upcoming (print top 10 from now, includes holiday toggle based on upcoming toggle)
  pUpcoming.innerHTML = "";
  const includeHolUpcoming = holUpcomingToggle.checked;
  const now = new Date();
  const upMerged = [
    ...primaryEvents,
    ...(includeHolUpcoming ? holidayEvents : []),
  ]
    .filter(ev => startMs(ev) >= now.getTime())
    .sort((a,b)=> startMs(a)-startMs(b))
    .slice(0, 10);

  if (upMerged.length === 0){
    pUpcoming.textContent = "No upcoming events.";
  } else {
    for (const ev of upMerged){
      const row = document.createElement("div");
      row.className = "pupItem";
      row.innerHTML = `<span class="pupWhen">${escapeHtml(fmtUpcomingWhen(ev))}</span> — ${escapeHtml(ev.title)}`;
      pUpcoming.appendChild(row);
    }
  }

  // Journal entries (for the month, top N non-empty)
  pJournal.innerHTML = "";
  const entries = getJournalEntriesForMonth(viewMonth).slice(0, PRINT_JOURNAL_MAX);
  if (entries.length === 0){
    pJournal.textContent = "No journal entries this month.";
  } else {
    for (const ent of entries){
      const row = document.createElement("div");
      row.className = "pjItem";
      row.innerHTML = `<div class="pjDate">${escapeHtml(ent.date)}</div>
                       <div class="pjText">${escapeHtml(ent.text)}</div>`;
      pJournal.appendChild(row);
    }
  }
}

function getJournalEntriesForMonth(monthDate){
  // Collect journal entries in the current month only
  const Y = monthDate.getFullYear();
  const M = monthDate.getMonth();

  const entries = [];
  // Iterate days in month
  let d = new Date(Y, M, 1);
  while (d.getMonth() === M){
    const key = ymd(d);
    const v = localStorage.getItem(journalKey(key));
    if (v && String(v).trim().length > 0){
      const pretty = d.toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
      entries.push({ ymd: key, date: pretty, text: String(v).trim().slice(0, 240) });
    }
    d.setDate(d.getDate()+1);
  }
  // Most recent first
  entries.sort((a,b)=> b.ymd.localeCompare(a.ymd));
  return entries;
}

/** ===== Render ===== */
function render(){
  renderUpcoming();
  renderMonthGrid();
}

/** ===== Load ===== */
async function load(){
  buildMonthTabs();
  setAccentForMonth(viewMonth.getMonth());
  elStatus.textContent = "Loading local mirrored calendars… (run GitHub Action once if empty)";

  try{
    const [primaryText, holidayText] = await Promise.all([
      fetch(PRIMARY_ICS_URL, { cache:"no-store" }).then(r => {
        if (!r.ok) throw new Error(`Missing ${PRIMARY_ICS_URL} (run the GitHub Action once). Status ${r.status}`);
        return r.text();
      }),
      fetch(HOLIDAYS_ICS_URL, { cache:"no-store" }).then(r => {
        if (!r.ok) throw new Error(`Missing ${HOLIDAYS_ICS_URL} (run the GitHub Action once). Status ${r.status}`);
        return r.text();
      }),
    ]);

    primaryEvents = parseICS(primaryText, "primary").sort((a,b)=> startMs(a)-startMs(b));
    holidayEvents = parseICS(holidayText, "holiday").sort((a,b)=> startMs(a)-startMs(b));

    elStatus.textContent = `Loaded ${primaryEvents.length} events + ${holidayEvents.length} holidays.`;

    selectedYMD = ymd(new Date());
    render();

    window.addEventListener("resize", debounce(() => renderMonthGrid(), 150));
  } catch (e){
    console.error(e);
    elStatus.textContent = String(e);
    elUpcoming.innerHTML = `<div class="upcomingItem"><div class="upcomingWhen">Error</div><div class="upcomingTitle">Calendar could not be loaded</div></div>`;
  }
}

buildMonthTabs();
load();
</script>
</body>
</html>
